# 0) –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞: –∫—Ç–æ –≤–æ–æ–±—â–µ —Ä–µ—à–∞–µ—Ç, –∫–∞–∫–∏–µ Œ± —Å—Ç–∞–≤–∏—Ç—å

**–§–∞–π–ª:** `rate_optimization.jl`
**–§—É–Ω–∫—Ü–∏—è:** `optimize_rates(steps; use_box_bfgs=true)`

* –¢—É—Ç —Å–æ–∑–¥–∞—ë—Ç—Å—è –ø–∞–∫–µ—Ç –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–≤:

  ```julia
  setup = setup_rate_optimization_objective(coarse_case, base_rate; ... , steps=steps)
  ```

  –í `setup` –ª–µ–∂–∞—Ç:

  * `x0` ‚Äî –Ω–∞—á–∞–ª—å–Ω—ã–π –≤–µ–∫—Ç–æ—Ä –¥–æ–ª–µ–π Œ±,
  * `obj` / `F!` / `dF!` / `F_and_dF!` ‚Äî –æ–±—ë—Ä—Ç–∫–∏ —Ü–µ–ª–∏/–≥—Ä–∞–¥–∏–µ–Ω—Ç–∞,
  * `lin_eq` ‚Äî –ª–∏–Ω–µ–π–Ω—ã–µ —Ä–∞–≤–µ–Ω—Å—Ç–≤–∞ Ax=b (—Å—É–º–º–∞ Œ± –ø–æ —à–∞–≥—É).
* **–ó–∞—Ç–µ–º –æ–ø—Ç–∏–º–∏–∑–∞—Ç–æ—Ä** (–æ–Ω –∏ ‚Äú—Ä–µ—à–∞–µ—Ç‚Äù, –∫–∞–∫–∏–µ Œ± –ª—É—á—à–µ):

  ```julia
  obj_best, x_best, hist = Jutul.unit_box_bfgs(setup.x0, setup.obj;
      maximize=true, lin_eq=setup.lin_eq)
  # –∏–ª–∏ lbfgsb(setup.F!, setup.dF!, setup.x0; lb=0, ub=1, ...)
  ```

  –û–Ω –±—É–¥–µ—Ç –º–Ω–æ–≥–æ–∫—Ä–∞—Ç–Ω–æ –≤—ã–∑—ã–≤–∞—Ç—å `setup.obj` (–∏–ª–∏ `F!`/`dF!`) —Å —Ä–∞–∑–Ω—ã–º–∏ `x`, —Å—Ä–∞–≤–Ω–∏–≤–∞—Ç—å NPV –∏ –¥–≤–∏–≥–∞—Ç—å `x` (Œ±).

---

# 1) –ì–¥–µ –ø—Ä–æ–≥—Ä–∞–º–º–∞ ¬´–ø–æ–Ω–∏–º–∞–µ—Ç¬ª, **—á—Ç–æ –ø–æ—Å—Ç–∞–≤–∏—Ç—å –Ω–∞ –∏–Ω–∂–µ–∫—Ç–æ—Ä–∞—Ö** (Œ± ‚Üí —Ü–µ–ª–µ–≤—ã–µ –¥–µ–±–∏—Ç—ã)

**–§–∞–π–ª:** `objectives.jl`
**–§—É–Ω–∫—Ü–∏—è:** `setup_rate_optimization_objective(...)` ‚Üí –≤–Ω—É—Ç—Ä–µ–Ω–Ω—è—è **`f!(x; grad=true)`**

1. `x` –ø—Ä–∏–≤–æ–¥–∏—Ç—Å—è –∫ –º–∞—Ç—Ä–∏—Ü–µ –¥–æ–ª–µ–π:

   ```julia
   x_mat = reshape(x, ninj, nstep_unique)   # Œ±[j,i]
   ```
2. –î–ª—è **–∫–∞–∂–¥–æ–≥–æ —à–∞–≥–∞ i** –∏ **–∫–∞–∂–¥–æ–≥–æ –∏–Ω–∂–µ–∫—Ç–æ—Ä–∞ j** —Å—Ç—Ä–æ–∏—Ç—Å—è —É—Å—Ç–∞–≤–∫–∞:

   ```julia
   max_rate = max_rate_factor*base_rate     # Qmax per well
   new_rate   = max(x_mat[j,i]*max_rate, MIN_INITIAL_WELL_RATE)
   new_target = TotalRateTarget(new_rate)
   f_forces   = case.forces[i][:Facility]
   ctrl       = f_forces.control[injectors[j]]
   f_forces.control[injectors[j]] = replace_target(ctrl, new_target)
   f_forces.limits[injectors[j]]  = merge(lims, as_limit(new_target))
   ```

   üëâ **–ó–¥–µ—Å—å** –∏ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç ¬´–ø–æ—Å—Ç–∞–≤–∏—Ç—å Œ±¬ª: –¥–æ–ª—è —É–º–Ω–æ–∂–∞–µ—Ç—Å—è –Ω–∞ `Qmax`, –∏ —Ü–µ–ª–µ–≤–æ–π –¥–µ–±–∏—Ç –∏–Ω–∂–µ–∫—Ç–æ—Ä–∞ –Ω–∞ —à–∞–≥–µ –∑–∞–º–µ–Ω—è–µ—Ç—Å—è –Ω–∞ `new_target`.

**–ß–∏—Å–ª–æ (—Ç–≤–æ–π –∫–µ–π—Å):** `base_rate‚âà0.0009201389 –º¬≥/—Å` (=79.5 –º¬≥/—Å—É—Ç), `max_rate_factor=10` ‚Üí
`Qmax‚âà0.0092013889 –º¬≥/—Å` (=795 –º¬≥/—Å—É—Ç). –ï—Å–ª–∏ `Œ±=0.12`, —Ç–æ `new_rate=0.12*Qmax=0.00110417 –º¬≥/—Å` (=**95.4 –º¬≥/—Å—É—Ç**).

---

# 2) –ì–¥–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è **–ø—Ä—è–º–æ–π –ø—Ä–æ–≥–æ–Ω** (forward model)

**–¢–∞–º –∂–µ, –≤–Ω—É—Ç—Ä–∏ `f!`:**

```julia
sim  = simulate_reservoir(case; output_substates=use_ministeps, info_level=-1, sim_arg...)
r    = sim.result
```

* –ù–∞ –≤—ã—Ö–æ–¥–µ `r.states`/`r.reports`: –¥–∞–≤–ª–µ–Ω–∏—è, –Ω–∞—Å—ã—â–µ–Ω–Ω–æ—Å—Ç–∏, —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –¥–µ–±–∏—Ç—ã –ø–æ —Å–∫–≤–∞–∂–∏–Ω–∞–º/–ø–æ–ª—é (`:fwir`, `:fopr`, –∏ —Ç.–ø.).
* –ü–æ —Ç–≤–æ–µ–º—É –ª–æ–≥—É: `:fwir ‚âà 0.00736111 –º¬≥/—Å` = **636 –º¬≥/—Å—É—Ç** (—á—Ç–æ —Ä–∞–≤–Ω–æ `0.8 * Qmax`).

---

# 3) –ì–¥–µ —Å—á–∏—Ç–∞–µ—Ç—Å—è –∏ **—Å—Ä–∞–≤–Ω–∏–≤–∞–µ—Ç—Å—è** —Ü–µ–ª—å (NPV)

**–í–Ω—É—Ç—Ä–∏ `f!`** —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è **–æ–±—ä–µ–∫—Ç —Ü–µ–ª–∏** (–∑–∞–º—ã–∫–∞–Ω–∏–µ) —á–µ—Ä–µ–∑ `npv_objective(...)`, –∞ –ø–æ—Ç–æ–º:

```julia
obj = Jutul.evaluate_objective(npv_obj, case.model, r.states, case.dt, case.forces)
```

* –í–Ω—É—Ç—Ä–∏ `npv_objective(...)` (—Ç–æ—Ç –∂–µ —Ñ–∞–π–ª) –Ω–∞ –∫–∞–∂–¥–æ–º —à–∞–≥–µ –±–µ—Ä—É—Ç—Å—è QoI —Å–∫–≤–∞–∂–∏–Ω:

  ```julia
  orat = compute_well_qoi(..., SurfaceOilRateTarget)   / liquid_unit
  wrat = compute_well_qoi(..., SurfaceWaterRateTarget) / liquid_unit
  grat = compute_well_qoi(..., SurfaceGasRateTarget)   / gas_unit
  ```

  –∏ —Å–æ–±–∏—Ä–∞–µ—Ç—Å—è –¥–µ–Ω–µ–∂–Ω—ã–π –ø–æ—Ç–æ–∫ –∑–∞ —à–∞–≥ —Å –¥–∏—Å–∫–æ–Ω—Ç–æ–º:

  ```julia
  cash = ( + oil_price*orat + gas_price*grat + water_price*wrat  # –ø—Ä–æ–¥—é—Å–µ—Ä—ã
           - (oil_cost*orat + gas_cost*grat + water_cost*wrat) ) # –∏–Ω–∂–µ–∫—Ç–æ—Ä—ã
  J_i  = sgn * dt * cash * (1+discount_rate)^(-time/discount_unit) / scale
  ```

  –°—É–º–º–∞ –ø–æ —à–∞–≥–∞–º = **NPV**.

üëâ **‚Äú–°—Ä–∞–≤–Ω–µ–Ω–∏–µ‚Äù –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤** –¥–µ–ª–∞–µ—Ç **–æ–ø—Ç–∏–º–∏–∑–∞—Ç–æ—Ä** (BFGS/L-BFGS-B): –æ–Ω –≤—ã–∑—ã–≤–∞–µ—Ç `f!` —Å —Ä–∞–∑–Ω—ã–º–∏ `x`, –ø–æ–ª—É—á–∞–µ—Ç **—á–∏—Å–ª–æ NPV**, —Å—Ä–∞–≤–Ω–∏–≤–∞–µ—Ç –∏ –¥–≤–∏–≥–∞–µ—Ç `x` –¥–∞–ª—å—à–µ. –í –ª–æ–≥–µ —ç—Ç–æ –∫–æ–ª–æ–Ω–∫–∞ `Objective`.

---

# 4) –ì–¥–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è **–æ–±—Ä–∞—Ç–Ω—ã–π –ø—Ä–æ–≥–æ–Ω** (adjoint / reverse) –∏ –≥–¥–µ –ª–µ–∂–∏—Ç –≥—Ä–∞–¥–∏–µ–Ω—Ç

**–°–Ω–æ–≤–∞ –≤–Ω—É—Ç—Ä–∏ `f!`** (–µ—Å–ª–∏ `grad=true`):

1. –ì–æ—Ç–æ–≤–∏–º —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –∏ —Ä–µ—à–∞–µ–º —Å–æ–ø—Ä—è–∂—ë–Ω–Ω—É—é –∑–∞–¥–∞—á—É ¬´–ø–æ —Å–∏–ª–∞–º¬ª:

   ```julia
   storage = Jutul.setup_adjoint_forces_storage(case.model, r.states, case.forces, case.dt, npv_obj; ...)
   dforces, t_to_f, grad_adj =
       Jutul.solve_adjoint_forces!(storage, case.model, r.states, r.reports, npv_obj, case.forces; ...)
   ```

   * **–ì–¥–µ ‚Äú—Å—ã—Ä—ã–µ‚Äù —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏:**
     `dforces[step][:Facility].control[well].target.value` = ‚àÇNPV/‚àÇ(target\_rate).

2. –ü–µ—Ä–µ–≤–æ–¥–∏–º –≤ –≥—Ä–∞–¥–∏–µ–Ω—Ç –ø–æ –¥–æ–ª—è–º Œ±:

   ```julia
   df = zeros(ninj, nstep_unique)
   for step in 1:nstep_unique, (j, inj) in enumerate(injectors)
       do_dq      = dforces[step][:Facility].control[inj].target.value  # ‚àÇNPV/‚àÇq_target
       df[j,step] = do_dq * max_rate                                    # ‚àÇNPV/‚àÇŒ± = (‚àÇNPV/‚àÇq)*Qmax
   end
   grad = vec(df)   # –≤–µ–∫—Ç–æ—Ä –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ç–æ—Ä–∞
   ```

   * **–ì–¥–µ ¬´–∂–∏–≤—É—Ç¬ª –≥—Ä–∞–¥–∏–µ–Ω—Ç—ã:**
     ‚Ä¢ –ø–æ —Ç–∞—Ä–≥–µ—Ç-–¥–µ–±–∏—Ç–∞–º ‚Äî –≤ `dforces[...]` (—Å–º. –≤—ã—à–µ),
     ‚Ä¢ –ø–æ –¥–æ–ª—è–º Œ± ‚Äî –≤ `df[j, step]`,
     ‚Ä¢ –ø–ª–æ—Å–∫–∏–π –≤–µ–∫—Ç–æ—Ä –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ç–æ—Ä–∞ ‚Äî `vec(df)`.

**–ß–∏—Å–ª–æ:** –ø—Ä–∏ `Qmax=795 –º¬≥/—Å—É—Ç` –∏ `do_dq=2000 $/(–º¬≥/—Å—É—Ç)` ‚Üí `‚àÇNPV/‚àÇŒ±=2000*795=**1.59e6 $**`.

---

# 5) –ì–¥–µ **–æ–ø—Ç–∏–º–∏–∑–∞—Ç–æ—Ä** –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —ç—Ç–æ –∏ ¬´—Ä–µ—à–∞–µ—Ç¬ª –Ω–æ–≤—ã–µ Œ±

**–§–∞–π–ª:** `rate_optimization.jl`
**–§—É–Ω–∫—Ü–∏—è:** `optimize_rates(...)`

* –ó–∞–ø—É—Å–∫:

  ```julia
  obj_best, x_best, hist = Jutul.unit_box_bfgs(setup.x0, setup.obj;
      maximize=true, lin_eq=setup.lin_eq)
  ```

  –∏–ª–∏

  ```julia
  results, x_best = lbfgsb(setup.F!, setup.dF!, setup.x0; lb=0, ub=1, ...)
  ```
* –ß—Ç–æ **–ø–æ–ª—É—á–∞–µ—Ç** –æ–ø—Ç–∏–º–∏–∑–∞—Ç–æ—Ä –Ω–∞ –∫–∞–∂–¥–æ–º —à–∞–≥–µ:

  * **–∑–Ω–∞—á–µ–Ω–∏–µ —Ü–µ–ª–∏** `F(x)` = NPV,
  * **–≥—Ä–∞–¥–∏–µ–Ω—Ç** `‚àáF(x)` = `vec(df)`,
  * **–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è:** –±–æ–∫—Å `0‚â§x‚â§1`, —Ä–∞–≤–µ–Ω—Å—Ç–≤–∞ `A x = b`.
* –ß—Ç–æ **–¥–µ–ª–∞–µ—Ç**:

  * —Å—Ç—Ä–æ–∏—Ç –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏–∑ —Ç–µ–∫—É—â–µ–≥–æ –≥—Ä–∞–¥–∏–µ–Ω—Ç–∞ (BFGS/L-BFGS-B),
  * –ø–æ–¥–±–∏—Ä–∞–µ—Ç —à–∞–≥ (line search),
  * –ø—Ä–æ–µ–∫—Ç–∏—Ä—É–µ—Ç –Ω–∞ –¥–æ–ø—É—Å—Ç–∏–º—É—é –æ–±–ª–∞—Å—Ç—å (`[0,1]` –∏ `A x=b`),
  * **‚Äú—Å—Ä–∞–≤–Ω–∏–≤–∞–µ—Ç‚Äù** `Objective` —Å—Ç–∞—Ä–æ–≥–æ/–Ω–æ–≤–æ–≥–æ `x` (—ç—Ç–æ —Ç–æ, —á—Ç–æ —Ç—ã –≤–∏–¥–∏—à—å –≤ —Ç–∞–±–ª–∏—Ü–µ),
  * –ø–æ–≤—Ç–æ—Ä—è–µ—Ç –¥–æ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏.
* –ß—Ç–æ **–≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç**: `x_best` (–ª—É—á—à–∞—è –Ω–∞–π–¥–µ–Ω–Ω–∞—è Œ±), `obj_best` (–ª—É—á—à–∏–π NPV), –∏ `hist` (—Ç–∞–±–ª–∏—Ü–∞ –∏—Ç–µ—Ä–∞—Ü–∏–π).

---

# 6) –ì–¥–µ —Ñ–æ—Ä–º–∏—Ä—É—é—Ç—Å—è **–æ–±—ë—Ä—Ç–∫–∏** `setup.obj` / `setup.F!` / `setup.dF!` / `setup.F_and_dF!`

**–§–∞–π–ª:** `objectives.jl` ‚Üí `setup_rate_optimization_objective(...)`

* –í–Ω—É—Ç—Ä–∏ —Å–æ–∑–¥–∞—ë—Ç—Å—è **`f!(x; grad)`** (–æ–ø–∏—Å–∞–Ω –≤—ã—à–µ) –∏ –Ω–∞ –µ–≥–æ –æ—Å–Ω–æ–≤–µ ‚Äî –æ–±—ë—Ä—Ç–∫–∏:

  * `setup.obj` ‚Äî –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å ¬´–∑–Ω–∞—á–µ–Ω–∏–µ + –≥—Ä–∞–¥–∏–µ–Ω—Ç¬ª –¥–ª—è `unit_box_bfgs`
    (–≤—ã–∑–æ–≤–µ—Ç `f!(x; grad=true)` –∏ –æ—Ç–¥–∞—Å—Ç –æ–±–∞).
  * `setup.F!` ‚Äî ¬´—Ç–æ–ª—å–∫–æ –∑–Ω–∞—á–µ–Ω–∏–µ¬ª (–¥–ª—è L-BFGS-B).
  * `setup.dF!` ‚Äî ¬´—Ç–æ–ª—å–∫–æ –≥—Ä–∞–¥–∏–µ–Ω—Ç¬ª (–∫–æ–ø–∏—Ä—É–µ—Ç `vec(df)` –≤ –±—É—Ñ–µ—Ä –æ–ø—Ç–∏–º–∏–∑–∞—Ç–æ—Ä–∞).
  * `setup.F_and_dF!` ‚Äî ¬´–æ–±–∞ —Å—Ä–∞–∑—É¬ª (–µ—Å–ª–∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ç–æ—Ä —É–º–µ–µ—Ç).

---

# 7) –ö—É–¥–∞ ‚Äú–≤–ø–ª–µ—Ç–∞—é—Ç—Å—è‚Äù **—Ä–∞–≤–µ–Ω—Å—Ç–≤–∞** –∏ **–≥—Ä–∞–Ω–∏—Ü—ã 0..1**

* **–†–∞–≤–µ–Ω—Å—Ç–≤–∞ `A x = b`:** —Å–æ–±—Ä–∞–Ω—ã –≤ `setup.lin_eq` (—Ç–∞–º –∂–µ, –≤ `objectives.jl`)
  –∏ –ø–µ—Ä–µ–¥–∞–Ω—ã –≤ `Jutul.unit_box_bfgs(..., lin_eq=setup.lin_eq)`.
  –í `:each`: `A` ‚Äî –ø–æ —Å—Ç—Ä–æ–∫–µ –Ω–∞ —à–∞–≥, `b[i]=ninj/max_rate_factor` (=**0.8** —É —Ç–µ–±—è).
* **–ë–æ–∫—Å `0..1`:** –≤—Å—Ç—Ä–æ–µ–Ω –≤ `unit_box_bfgs`; –≤ `lbfgsb` –∑–∞–¥–∞—ë—Ç—Å—è –∫–∞–∫ `lb=zeros(...)`, `ub=ones(...)`.

---

## ¬´–û–¥–∏–Ω —Ü–∏–∫–ª¬ª –≤ —Ü–∏—Ñ—Ä–∞—Ö (—Å–≤–µ—Ä–∫–∞ —Å —Ç–≤–æ–∏–º –ª–æ–≥–æ–º)

* **–°—Ç–∞—Ä—Ç:** `x0 .= 0.1` (8 –∏–Ω–∂–µ–∫—Ç–æ—Ä–æ–≤ √ó 50 —à–∞–≥–æ–≤), –Ω–∞ –∫–∞–∂–¥–æ–º —à–∞–≥–µ —Å—É–º–º–∞ Œ± = **0.8**.
  –ü–æ–¥—Å—Ç–∞–≤–∏–ª–∏ ‚Üí forward ‚Üí `:fwir ‚âà 0.00736111 –º¬≥/—Å` (**636 –º¬≥/—Å—É—Ç**) ‚Äî —ç—Ç–æ –∏ –≤–∏–¥–∏—à—å –≤ –æ—Ç—á—ë—Ç–∞—Ö.
  –ü–æ—Å—á–∏—Ç–∞–ª–∏ NPV: `Objective ‚âà 2.1311e+08`.
* **Adjoint:** –ø–æ–ª—É—á–∏–ª–∏ `dforces` ‚Üí `df = do_dq * Qmax` ‚Üí `vec(df)`.
* **BFGS-—à–∞–≥:** –æ–ø—Ç–∏–º–∏–∑–∞—Ç–æ—Ä –¥–≤–∏–≥–∞–µ—Ç `x` (—Å–æ—Ö—Ä–∞–Ω—è—è `Ax=b` –∏ `0‚â§x‚â§1`), —Å–Ω–æ–≤–∞ –≤—ã–∑—ã–≤–∞–µ—Ç `f!`.
  –í –ª–æ–≥–µ: NPV —Ä–∞—Å—Ç—ë—Ç (`2.1342e+08` ‚Üí ‚Ä¶ ‚Üí **`2.1931e+08`**), –ø–µ—á–∞—Ç–∞–µ—Ç—Å—è `Proj. grad`, `Linesearch-its`.
* **–§–∏–Ω–∏—à:** `x_best` (400 —á–∏—Å–µ–ª) ‚Äî –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–µ –¥–æ–ª–∏; –µ—Å–ª–∏ –∏—Ö –ø–æ—Å—Ç–∞–≤–∏—Ç—å –∏ –ø—Ä–æ–≥–Ω–∞—Ç—å, –ø–æ–ª—É—á–∏—à—å —Ñ–∏–Ω–∞–ª—å–Ω—ã–µ `:fopr`, `:fwir`, `:fwpr` –∏ —Ç.–ø.

---

–µ—Å–ª–∏ —Ö–æ—á–µ—à—å, –¥–∞–º –∫–æ—Ä–æ—Ç–∫–∏–π ‚Äú–¥–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∏–π‚Äù –ø–∞—Ç—á (–Ω–µ—Å–∫–æ–ª—å–∫–æ `@info`) **—Ä–æ–≤–Ω–æ –≤ —Ç–µ –º–µ—Å—Ç–∞**:

* –ø–µ—Ä–µ–¥ `simulate_reservoir` ‚Äî –ø–µ—á–∞—Ç–∞—Ç—å —Å—É–º–º—É Œ± –ø–æ —à–∞–≥–∞–º –∏ –æ–∂–∏–¥–∞–µ–º—ã–π `Q_field`;
* –ø–æ—Å–ª–µ `evaluate_objective` ‚Äî –ø–µ—á–∞—Ç–∞—Ç—å —Ç–µ–∫—É—â–µ–µ `Objective`;
* —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ `solve_adjoint_forces!` ‚Äî –ø–µ—á–∞—Ç–∞—Ç—å –ø–∞—Ä—É `do_dq` –∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π `df[j,i]`;
* –≤ `optimize_rates` ‚Äî –ø–µ—á–∞—Ç–∞—Ç—å —Ä–∞–∑–º–µ—Ä–Ω–æ—Å—Ç–∏ `x`, `A`, –Ω–æ—Ä–º—É –Ω–∞—Ä—É—à–µ–Ω–∏—è `‚ÄñAx‚àíb‚Äñ`.
